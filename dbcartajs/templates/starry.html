{% extends 'base.html' %}
{% load i18n %}
{% block title %}dbCartajs - HTML5 Canvas map - Starry Sky Demo{% endblock %}
{% block script %}
<script type="text/javascript" src="/media/js/proj4js-combined.js"></script>
<script type="text/javascript" src="/media/js/dbcarta.js"></script>
<script type="text/javascript" src="/media/js/demodata/continents.js"></script>
<script type="text/javascript" src="/media/js/demodata/stars.js"></script>
<!--script type="text/javascript" src="/media/js/demodata/stars_tycho.js"></script-->
<script type="text/javascript" src="/media/js/demodata/tledata.js"></script>
<script type="text/javascript" src="/media/js/utils/starry.js"></script>
<script type="text/javascript" src="/media/js/utils/updater.js"></script>
<script type="text/javascript" src="/media/js/sgp4/satellite.js"></script>
<script type="text/javascript">
  function draw() {
    if (dbcarta.isSpherical()) {
      var proj = dbcarta.initProj();
      var projh = document.getElementById('projh').value * 1000,
          cx = proj.long0 * 180/Math.PI,
          cy = proj.lat0 * 180/Math.PI;
      // scale by altitude (height)
      dbcarta.initProj(' +h=' + projh + ' +lon_0=' + cx + ' +lat_0=' + cy);
      dbcarta.scaleCarta(1);
      dbcarta.scaleCarta(1/scaleheight());
      dbcarta.draw();
      loadStarry();
    }
  }
  // Rotate Sphere on sides
  function turn(cx, cy) {
    if (!isNaN(cx) && !isNaN(cy))
      if (dbcarta.isSpherical()) {
        var proj = dbcarta.initProj();
        cx += proj.long0 * 180/Math.PI;
        cy += proj.lat0 * 180/Math.PI;
        dbcarta.initProj(' +h=' + proj.h + ' +lon_0=' + cx + ' +lat_0=' + cy);
        dbcarta.draw();
        loadStarry();
      }
  }
  // Calcucate Right Ascention and Declination (Ra/Dec)
  function calcSpheric(coords, dt) {
    var proj = dbcarta.initProj();
    var skyratio = proj.h/proj.a;
        gmst = Starry.siderealTime(dt),
        skyRotationAngle = gmst / 12.0 * Math.PI;
    coords[0] /= skyratio;
    coords[1] /= skyratio;
    var cy = -proj.lat0 * 180/Math.PI,
        cx = proj.long0 * 180/Math.PI + skyRotationAngle * 180/Math.PI;
    var skyproj = "+proj=ortho +units=m +a=" + proj.a + " +b=" + proj.b + " +lon_0=" + cx + " +lat_0=" + cy;
    Proj4js.defs["SKY"] = skyproj;
    var pt = dbcarta.transformCoords("SKY", 'epsg:4326', coords);
    if (pt) {
      // backside
      pt[0] = Proj4js.common.adjust_lon((180 - (pt[0] - cx) + cx) * Math.PI/180);
      pt[1] = pt[1] * Math.PI/180;
    }
    return pt;
  }
  // Draw points (stars, tracs) on lonlat
  function drawlonlat(pts, ftype){
    var proj = dbcarta.initProj();
    var cx = proj.long0 * 180/Math.PI,
        cy = proj.lat0 * 180/Math.PI;
    // switch to lonlat
    dbcarta.initProj(0, '');
    for(var i in pts) {
      dbcarta.mopt[ftype]['size'] = pts[i][1] / 8;
      dbcarta.paintCarta(pts[i][0], ftype, pts[i][2]);
    }
    // restore spherical proj
    dbcarta.initProj(202, ' +h=' + proj.h + ' +lon_0=' + cx + ' +lat_0=' + cy);
  }
  // Render sky obj
  function loadStarry(){
    var proj = dbcarta.initProj();
    var rect = dbcarta.viewsizeOf(),
        skyRadius = 180/Math.PI * proj.h/proj.a,
        eaRadius = Math.sqrt((proj.p15 - 1.0)/(proj.p15 + 1.0)) * 180/Math.PI,
        eaRadiusM = proj.a,
        cx = proj.long0 * 180/Math.PI,
        cy = proj.lat0 * 180/Math.PI,
        gmtime = getSelTime();
    // draw stars
    var stars = window.STARS,
        mstars = Starry.renderSky(stars, rect, skyRadius, eaRadius, cx, cy, gmtime);
    drawlonlat(mstars, 'star');
    // sat.tracs
    var tledata = window.TLEDATA;
    for (var i in tledata){
      var pos = [];
      var satrec = satellite.twoline2satrec(tledata[i][1], tledata[i][2]);
      // by 2 mean motion ago
      var utc1 = Date.UTC(gmtime[0], gmtime[1], gmtime[2], gmtime[3], gmtime[4], gmtime[5]),
          ps = Math.PI * 1/satrec.no * 60.0 * 2.0,
          delta = 0, step = ps / 100.0, vrect = [];
      while (delta < ps){
        var utc2 = new Date();
        utc2.setTime(utc1 - delta * 1000);
        var pv = satellite.propagate(satrec, utc2.getUTCFullYear(), utc2.getUTCMonth()+1, utc2.getUTCDate(), utc2.getHours(), utc2.getMinutes(), utc2.getSeconds());
        delta += step;
        vrect.push(pv[0]);
      }
      var tracs = [tledata[i][0], vrect];
      var mtracs = Starry.renderSat(tracs[1], rect, eaRadius, eaRadiusM, cx, cy, gmtime),
          mcoords = MVector.rect2geo(gmtime, tracs[1][0][0], tracs[1][0][1], tracs[1][0][2]);
      drawlonlat(mtracs[1], 'sattrac');
      dbcarta.paintCarta([mcoords], 'satsurface');
      if ((label = mtracs[0]).length) {
        // sat.fields of vision
        var pts = MVector.circle1spheric(mcoords[0], mcoords[1], MVector.AE * 18 * Math.PI/180, 20);
        // conv to lonlat
        for(var j in pts){
          if (pt = dbcarta.transformCoords('epsg:4326', String(dbcarta.project), pts[j])) {
            // backside intersect ea
            if (!pt[2])
              pt = MVector.lineNcircle([ label[0][0][0], pt ], eaRadius);
            // triangle sector
            if (j > 0)
              drawlonlat([[[label[0][0][0], pt, pt1]]], 'sector');
            // previous pt
            var pt1 = pt;
          }
        }
        // draw sat.label
        drawlonlat([[[label[0][0][0]], 16, tracs[0]]], 'satpos');
      }
    }
  }
  // Calc maps scale by height above Earth
  function scaleheight() {
    var proj = dbcarta.initProj();
    var rhscale = ((proj.p15 - 1.0)/(proj.p15 + 1.0));
    // skyratio measure above 40000 km
    var etalon_p15 = (1.0 + 40000000/proj.a);
    var etalon_rhscale = ((etalon_p15 - 1.0)/(etalon_p15 + 1.0));
    return (rhscale/etalon_rhscale * rhscale/etalon_rhscale);
  }
  function getCurrTime() {
    var dt = new Date();
    return [dt.getUTCFullYear(), dt.getUTCMonth()+1, dt.getUTCDate(), dt.getUTCHours(), dt.getUTCMinutes(), dt.getUTCSeconds()];
  }
  function getSelTime() {
    return [Number(document.getElementById("yy").value),
            Number(document.getElementById("mm").value),
            Number(document.getElementById("dd").value),
            Number(document.getElementById("hh").value),
            Number(document.getElementById("mi").value),
            Number(document.getElementById("ss").value)]
  }
  function setSelTime() {
    var dt = getCurrTime();
    document.getElementById("yy").value = dt[0];
    document.getElementById("mm").value = dt[1];
    document.getElementById("dd").value = dt[2];
    document.getElementById("hh").value = dt[3];
    document.getElementById("mi").value = dt[4];
    document.getElementById("ss").value = dt[5];
  }
  function setAutoTime() {
    if (window.autotime) {
      window.autotime = window.clearInterval(window.autotime);
      document.getElementById("btauto").textContent = "auto";
    } else {
      window.autotime = setInterval(function() {
        setSelTime();
        draw();
      }, 4000);
      document.getElementById("btauto").textContent = "stop";
    }
  }
  function init() {
    var mtab = document.createElement("table");
    mtab.width = "100%";
    var row = document.createElement("tr");
    row.style.backgroundColor = "rgb(230,230,230)";
    mtab.appendChild(row);

    var col = document.createElement("td");
    col.width = "15%";
    var el = document.createElement("h2");
    el.appendChild(document.createTextNode("Starry Sky Demo"));
    el.style.padding = "0";
    el.style.margin = "0";
    col.appendChild(el);
    row.appendChild(col);

    col = document.createElement("td");
    col.width = "10%";
    col.align = "center";
    el = document.createElement('button');
    el.onclick = function() { turn(0, -5) };
    el.title = "Turn Up";
    el.appendChild(document.createTextNode("U"));
    col.appendChild(el);
    el = document.createElement('button');
    el.onclick = function() { turn(0, 5) };
    el.title = "Turn Down";
    el.appendChild(document.createTextNode("D"));
    col.appendChild(el);
    el = document.createElement('button');
    el.onclick = function() { turn(5, 0) };
    el.title = "Turn Left";
    el.appendChild(document.createTextNode("L"));
    col.appendChild(el);
    el = document.createElement('button');
    el.onclick = function() { turn(-5, 0) };
    el.title = "Turn Right";
    el.appendChild(document.createTextNode("R"));
    col.appendChild(el);
    row.appendChild(col);

    col = document.createElement("td");
    col.width = "10%";
    col.align = "center";
    col.appendChild(document.createTextNode("height ae "));
    var projh = el = document.createElement("select");
    el.id = "projh";
    col.appendChild(el);
    row.appendChild(col);

    col = document.createElement("td");
    col.width = "20%";
    col.align = "center";
    var yy = document.createElement("select");
    yy.id = "yy";
    var mm = document.createElement("select");
    mm.id = "mm";
    var dd = document.createElement("select");
    dd.id = "dd";
    dd.style.marginRight = "1em";
    var hh = document.createElement("select");
    hh.id = "hh";
    var mi = document.createElement("select");
    mi.id = "mi";
    var ss = document.createElement("select");
    ss.id = "ss";
    el = document.createElement("button");
    el.id = "btauto";
    el.onclick = setAutoTime;
    el.title = "autoupdate by interval";
    el.appendChild(document.createTextNode("auto"));
    col.appendChild(yy);
    col.appendChild(document.createTextNode("-"));
    col.appendChild(mm);
    col.appendChild(document.createTextNode("-"));
    col.appendChild(dd);
    col.appendChild(hh);
    col.appendChild(document.createTextNode(":"));
    col.appendChild(mi);
    col.appendChild(document.createTextNode(":"));
    col.appendChild(ss);
    col.appendChild(el);
    row.appendChild(col);

    col = document.createElement("td");
    col.width = "15%";
    col.align = "center";
    col.id = "coords";
    row.appendChild(col);
    document.body.appendChild(mtab);

    dbcarta = new dbCarta();
    // change/define colors and flood types
    dbcarta.style.backgroundColor = "rgb(17,17,96)";
    dbcarta.mopt['.Arctic']['fg'] = "rgb(131,147,125)";
    dbcarta.mopt['.Arctic']['bg'] = "rgb(131,147,125)";
    dbcarta.mopt['.Mainland']['fg'] = "rgb(71,87,125)";
    dbcarta.mopt['.Mainland']['bg'] = "rgb(71,87,125)";
    dbcarta.mopt['.Latitude']['fg'] = "rgb(7,7,186)";
    dbcarta.mopt['.Longtitude']['fg'] = "rgb(7,7,186)";
    dbcarta.mopt['DotPort']['fg'] = "rgb(220,0,0)";
    dbcarta.mopt['DotPort']['labelcolor'] = "rgb(255,155,128)";
    dbcarta.mopt['DotPort']['size'] = "3";
    dbcarta.mopt['star'] = {};
    dbcarta.mopt['star']['class'] = 'Dot';
    dbcarta.mopt['star']['fg'] = "rgb(255,255,255)";
    dbcarta.mopt['star']['labelcolor'] = "rgb(255,155,128)";
    dbcarta.mopt['satpos'] = {};
    dbcarta.mopt['satpos']['class'] = 'Dot';
    dbcarta.mopt['satpos']['fg'] = "rgb(200,200,170)";
    dbcarta.mopt['satpos']['labelcolor'] = "rgb(200,200,170)";
    dbcarta.mopt['sattrac'] = {};
    dbcarta.mopt['sattrac']['class'] = 'Line';
    dbcarta.mopt['sattrac']['fg'] = "rgba(200,200,170,0.1)";
    dbcarta.mopt['sattrac']['labelcolor'] = "rgb(200,200,170)";
    dbcarta.mopt['satsurface'] = {};
    dbcarta.mopt['satsurface']['class'] = 'Dot';
    dbcarta.mopt['satsurface']['fg'] = "rgb(0,220,0)";
    dbcarta.mopt['satsurface']['size'] = "2";
    dbcarta.mopt['sector'] = {};
    dbcarta.mopt['sector']['class'] = 'Polygon';
    dbcarta.mopt['sector']['fg'] = "rgba(200,200,170,0.1)";
    dbcarta.mopt['sector']['bg'] = "rgba(200,200,170,0.1)";
    dbcarta.mopt['sector']['width'] = '0.2';
    var pov = [37.700,55.750];
    var proj = dbcarta.initProj(202, ' +lon_0=' + pov[0] + ' +lat_0=' + pov[1]);
    // nsper proj height list
    for(var i=1000; i<103000; i+=3000) {
      el = document.createElement("option");
      el.value = i;
      if (i == 100000) el.selected = "true";
      el.appendChild(document.createTextNode(i + " km"));
      projh.appendChild(el);
    }
    // date years
    for(i=1999; i<2050; i++) {
      el = document.createElement("option");
      el.value = i;
      el.appendChild(document.createTextNode(i));
      yy.appendChild(el);
    }
    // date month
    for(i=1; i<13; i++) {
      el = document.createElement("option");
      el.value = i;
      el.appendChild(document.createTextNode(i));
      mm.appendChild(el);
    }
    // date days
    for(i=1; i<32; i++) {
      el = document.createElement("option");
      el.value = i;
      el.appendChild(document.createTextNode(i));
      dd.appendChild(el);
    }
    // time hours
    for(i=0; i<24; i++) {
      el = document.createElement("option");
      el.value = i;
      el.appendChild(document.createTextNode(i));
      hh.appendChild(el);
    }
    // time min
    for(i=0; i<60; i++) {
      el = document.createElement("option");
      el.value = i;
      el.appendChild(document.createTextNode(i));
      mi.appendChild(el);
    }
    // time sec
    for(i=0; i<60; i++) {
      el = document.createElement("option");
      el.value = i;
      el.appendChild(document.createTextNode(i));
      ss.appendChild(el);
    }
    // curr. coords
    dbcarta.clfunc.onmousemove = function(sd) {
      mcoord = document.getElementById("coords");
      mcoord.innerHTML = "Ra/Dec:";
      if (scoords = calcSpheric(sd, getSelTime())) {
        // in radians
        //mcoord.innerHTML = 'Ra: ' + scoords[0].toFixed(2) + ' Dec: ' + scoords[1].toFixed(2);
        // in hms, dms
        var ra = MUtil.deg2hms(scoords[0] * 180/Math.PI).join(':'),
            dec = MUtil.deg2dms(scoords[1] * 180/Math.PI).join(':');
        mcoord.innerHTML = 'Ra: ' + ra + ' Dec: ' + dec;
      }
    }
    // events
    projh.onchange = draw;
    yy.onchange = draw;
    mm.onchange = draw;
    dd.onchange = draw;
    hh.onchange = draw;
    mi.onchange = draw;
    ss.onchange = draw;
    dbcarta.clfunc.onclick = loadStarry;
    // draw
    dbcarta.loadCarta(window.CONTINENTS);
    dbcarta.loadCarta(dbcarta.createMeridians());
    dbcarta.loadCarta([['DotPort', '1', [pov], 'Moscow']]);
    window.CONTINENTS = undefined;
    setSelTime();
    draw();
  }
</script>
{% endblock %}